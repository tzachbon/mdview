# bat-style-output

## Goal
Change the CLI output of mdview to work like the 'bat' CLI - with syntax highlighting, line numbers, file headers, and git integration in terminal output.

## Completed Tasks
- [x] 1.1 Create pager module -- shouldPage + resolvePagerCommand
- [x] 1.2 Add pipeToPager to pager module
- [x] 1.4 Create decorator module -- parseStyle
- [x] 1.10 Wire decorator + pager into main() output pipeline
- [x] 1.12 POC end-to-end validation

## Current Task
Awaiting next task

## Progress
- [x] Research phase
- [x] Requirements phase
- [x] Design phase
- [ ] Tasks phase
- [ ] Execution phase

## Learnings
- Design: decorations are a post-processing step on render() output, NOT inside marked-terminal -- cleaner separation, easier testing, no coupling to marked internals
- Design: two new modules (decorator.ts, pager.ts) kept separate since pager and decoration are independent concerns
- Design: parseStyle() follows same pure-function pattern as parseArgs() -- no side effects, fully testable
- Design: ANSI escape sequences never contain literal \n, so splitting rendered output on \n for line numbering is safe
- Design: NO_COLOR takes precedence over FORCE_COLOR per no-color.org spec
- Design: --plain wins over --style when both specified (simpler than erroring)
- Design: Bun.spawn with array args avoids shell injection from MDVIEW_PAGER/PAGER env vars
- Design: renderer.ts requires zero changes -- all bat-style output is layered on top
- marked-terminal v7.3.0 already bundles cli-highlight v2.1.11 -- no new dep needed for syntax highlighting MVP
- marked-terminal's `markedTerminal(options, highlightOptions)` accepts cli-highlight options as second arg -- theme customization possible without overriding renderer
- marked v12 uses token-based renderer API: `code({ text, lang, escaped })` -- can be overridden via `marked.use({ renderer: { code(token) {} } })`
- marked-terminal's code renderer flow: `code() -> highlight() -> highlightCli() -> indentify() -> section()` -- well-structured for interception
- Bun.spawn uses posix_spawn, supports `stdin: "pipe"` + `stdout: "inherit"` for pager pattern -- verified compatible
- bat uses syntect (Sublime Text grammars) not tree-sitter for highlighting
- bat defaults to `less -R -F -X` for pager; git uses `less -FRX` -- same flags
- `-F` (quit-if-one-screen) + `-R` (raw ANSI) + `-X` (no-init) are the critical less flags for CLI pagers
- shiki's `codeToANSI` from `@shikijs/cli` provides VS Code-grade terminal highlighting but adds 1-6MB and async requirement -- defer to future spec
- Single output point at `src/index.ts:160` (`console.log(output)`) makes pager integration clean
- No existing npm package replicates bat's decoration system -- custom implementation with chalk + Unicode box-drawing chars needed
- `process.stdout.isTTY` is the standard check for smart paging (suppress decorations when piped)
- Requirements: line numbers apply to rendered output lines (not source markdown), matching bat's model of numbering displayed lines
- Requirements: `--plain` disables decorations only, NOT syntax highlighting or pager -- these are orthogonal concerns
- Requirements: `--style` uses "only listed components" semantics (not additive), matching bat's behavior
- Requirements: No new runtime dependencies needed -- chalk + cli-highlight (via marked-terminal) + Bun.spawn cover all MVP needs
- Requirements: Pager fallback chain is MDVIEW_PAGER > PAGER > less -RFX > direct stdout -- four levels of graceful degradation
- Requirements: NO_COLOR/FORCE_COLOR are standard env vars (no-color.org) that many CLIs respect -- important for accessibility
- Task planning: existing integration tests set FORCE_COLOR=1 in env -- decorator will activate in those tests, may need adjustment to expect decorated output or add --plain
- Task planning: parseArgs currently only handles first arg -- needs rewrite to loop over all args for multi-flag support (--plain --paging=never file.md)
- Task planning: `path.basename()` via `import { basename } from "node:path"` confirmed available in Bun runtime
- Task planning: 63 existing tests across 3 files (index, renderer, mermaid) all pass -- this is the regression baseline
- Task planning: piped stdout (Bun.spawn with stdout:"pipe") correctly makes isTTY false in child process -- useful for testing pipe behavior
- Execution: pager.ts follows same JSDoc + named export pattern as mermaid.ts -- module-level doc comment, exported types, exported functions with JSDoc
- Execution: tsconfig has noUncheckedIndexedAccess so env var access needs bracket notation (process.env["MDVIEW_PAGER"])
- Execution: pipeToPager destructures resolvePagerCommand() as [cmd, ...args] with a guard for empty cmd (noUncheckedIndexedAccess makes cmd possibly undefined)

## Learnings (new)
- POC validation: FORCE_COLOR=1 is required when running in piped context (automated tests) to force decorations since process.stdout.isTTY is false
- POC validation: decorated output correctly shows File header, line numbers with │, and grid borders with ─/┬/┴
- POC validation: --plain correctly suppresses all decorations
- POC validation: stdin mode correctly omits File: header while keeping grid/numbers
- POC validation: all 63 existing tests pass with no regressions

## Next
Task 2.1: Add --paging validation and error for invalid values
